# 视频生成脚本使用说明

## 概述

`generate_video.py` 脚本可以将PNG图片序列合成为MP4视频，支持单个文件夹处理和批量处理100个数据文件夹。

## 功能特点

- ✅ 支持单个数据文件夹处理
- ✅ 支持批量处理多个数据文件夹
- ✅ 支持并行处理（提高效率）
- ✅ 自动排序图片文件
- ✅ 可自定义视频参数（帧率、尺寸等）
- ✅ 完整的日志记录和错误处理
- ✅ 处理结果统计和保存

## 使用方法

### 1. 单个数据文件夹处理

```bash
# 基本用法
python generate_video.py --mode single --data_folder 20250820-151238

# 指定输出目录
python generate_video.py --mode single --data_folder 20250820-151238 --output_dir output_video

# 自定义视频参数
python generate_video.py --mode single --data_folder 20250820-151238 --fps 25 --width 1920 --height 1080
```

### 2. 批量处理多个数据文件夹

```bash
# 基本批量处理
python generate_video.py --mode batch --data_root data --output_dir output_video

# 并行处理（推荐）
python generate_video.py --mode batch --data_root data --output_dir output_video --parallel 4

# 自定义视频参数
python generate_video.py --mode batch --data_root data --output_dir output_video --parallel 4 --fps 30
```

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--mode` | string | `single` | 处理模式：`single` 或 `batch` |
| `--data_folder` | string | - | 单个数据文件夹名称 |
| `--data_root` | string | `data` | 数据根目录（批量模式使用） |
| `--output_dir` | string | `output_video` | 输出目录 |
| `--fps` | int | `30` | 视频帧率 |
| `--width` | int | 原图宽度 | 视频宽度 |
| `--height` | int | 原图高度 | 视频高度 |
| `--parallel` | int | `1` | 并行处理数量 |

## 输出结构

### 单个模式输出
```
output_video/
└── 20250820-151238.mp4
```

### 批量模式输出
```
output_video/
├── 20250820-151238.mp4
├── 20250821-123456.mp4
├── 20250822-234567.mp4
├── ...
└── video_generation_results.json  # 处理结果统计
```

## 性能建议

### 并行处理数量
```bash
# 根据CPU核心数设置
# 4核CPU
python generate_video.py --mode batch --parallel 4

# 8核CPU
python generate_video.py --mode batch --parallel 8

# 16核CPU
python generate_video.py --mode batch --parallel 8  # 建议不超过8个
```

### 视频参数优化
```bash
# 高质量视频（文件较大）
python generate_video.py --mode batch --fps 30 --width 1920 --height 1080

# 标准质量视频（平衡质量和大小）
python generate_video.py --mode batch --fps 25 --width 1280 --height 720

# 快速生成（文件较小）
python generate_video.py --mode batch --fps 15 --width 640 --height 480
```

## 示例使用场景

### 场景1：测试单个数据
```bash
python generate_video.py --mode single --data_folder 20250820-151238 --output_dir test_video
```

### 场景2：批量处理100个数据文件夹
```bash
# 分批处理，每批25个
python generate_video.py --mode batch --data_root data --output_dir batch1 --parallel 4
python generate_video.py --mode batch --data_root data --output_dir batch2 --parallel 4
python generate_video.py --mode batch --data_root data --output_dir batch3 --parallel 4
python generate_video.py --mode batch --data_root data --output_dir batch4 --parallel 4
```

### 场景3：生成高质量视频
```bash
python generate_video.py --mode batch --data_root data --output_dir hd_videos --parallel 4 --fps 30 --width 1920 --height 1080
```

### 场景4：快速预览视频
```bash
python generate_video.py --mode batch --data_root data --output_dir preview_videos --parallel 8 --fps 15 --width 640 --height 480
```

## 数据文件夹要求

每个数据文件夹必须包含以下结构：
```
data/
├── 20250820-151238/
│   ├── annotation/
│   │   ├── Screenshot_0.png
│   │   ├── Screenshot_1.png
│   │   ├── Screenshot_2.png
│   │   └── ...
│   └── Screenshot_summary.csv
├── 20250821-123456/
│   ├── annotation/
│   │   └── ...
│   └── Screenshot_summary.csv
└── ...
```

## 图片文件要求

- **格式**: PNG, JPG, JPEG, BMP, TIFF
- **命名**: 按数字顺序排序（如 Screenshot_0.png, Screenshot_1.png, ...）
- **尺寸**: 建议所有图片尺寸一致

## 错误处理

### 常见错误及解决方案

1. **图片目录不存在**
   ```
   错误: 图片目录不存在: data/xxx/annotation
   ```
   - 检查数据文件夹结构
   - 确保annotation目录存在

2. **未找到图片文件**
   ```
   错误: 在目录 xxx 中未找到图片文件
   ```
   - 检查annotation目录中是否有PNG文件
   - 确认文件扩展名正确

3. **无法读取图片**
   ```
   警告: 无法读取图片: xxx.png
   ```
   - 检查图片文件是否损坏
   - 确认图片格式支持

4. **内存不足**
   - 减少并行处理数量
   - 降低视频分辨率
   - 分批处理数据

## 监控进度

### 实时监控
```bash
# 查看处理日志
tail -f generate_video.log

# 查看处理结果
cat output_video/video_generation_results.json
```

### 处理结果示例
```json
{
  "folder": "20250820-151238",
  "success": true,
  "output_path": "output_video/20250820-151238.mp4",
  "file_size_mb": 8.23,
  "duration": 12.45
}
```

## 性能统计

脚本会生成详细的性能统计信息：
```
==================================================
批量视频生成统计信息:
总文件夹数: 100
成功生成: 98
生成失败: 2
成功率: 98.0%
总耗时: 1250.30秒
平均耗时: 12.50秒/文件夹
总文件大小: 823.45 MB
==================================================
```

## 注意事项

1. **磁盘空间**: 确保有足够的磁盘空间存储视频文件
2. **内存使用**: 并行处理会增加内存使用，根据系统配置调整
3. **CPU使用**: 视频编码是CPU密集型任务，建议根据CPU核心数设置并行数量
4. **网络存储**: 如果数据在网络存储上，建议先复制到本地处理
5. **备份**: 处理前建议备份原始图片数据

## 环境要求

```bash
# 安装依赖
pip install opencv-python numpy

# 检查OpenCV版本
python -c "import cv2; print(cv2.__version__)"
```
