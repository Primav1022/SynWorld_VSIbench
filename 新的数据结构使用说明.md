# 新的数据结构使用说明

## 概述

本项目已经重新设计了数据结构，实现了以下改进：

1. **统一的输出目录结构**：所有CSV文件输出到 `output_csv/对应数据文件名/` 目录
2. **简化的JSON格式**：去掉了metadata，只保留核心字段
3. **难度标签**：为不同难度的数据集添加了难度标签
4. **批量处理**：支持高效处理多个数据文件夹

## 目录结构

```
SynWorld_VSIbench/
├── data/                          # 原始数据文件夹
│   ├── 20250820-151238/
│   ├── 20250821-123456/
│   └── ...
├── output_csv/                    # 新的CSV输出目录
│   ├── 20250820-151238/
│   │   ├── ranked_unique_actor_anno.csv
│   │   ├── absolute_distances_all.csv
│   │   ├── object_size_all.csv
│   │   ├── room_size_all.csv
│   │   ├── object_count_all.csv
│   │   ├── relative_direction_all.csv
│   │   ├── relative_distance_all.csv
│   │   ├── route_plan_all.csv
│   │   └── appearance_order_all.csv
│   └── 20250821-123456/
│       └── ...
├── output_json/                   # 新的JSON输出目录
│   ├── 20250820-151238.json
│   ├── 20250821-123456.json
│   ├── summary.json
│   └── ...
└── output_video/                  # 视频输出目录
    ├── 20250820-151238.mp4
    ├── 20250821-123456.mp4
    └── ...
```

## 修改的脚本

### 1. 数据清理脚本
- **文件**: `0_data_cleanup_tool/anno_extraction.py`
- **功能**: 提取和清理演员信息
- **输出**: `output_csv/数据文件夹名/ranked_unique_actor_anno.csv`

### 2. 测量类脚本 (m_*)
- **m_absolute_distance_tool/absolute_distance_all.py**: 计算绝对距离
- **m_object_size_tool/object_size_all.py**: 计算物体尺寸
- **m_room_size_tool/room_size_all.py**: 计算房间尺寸
- **难度**: medium

### 3. 计数类脚本 (c_*)
- **c_object_count_tool/object_count_all.py**: 计算物体数量
- **c_relative_direction_tool/relative_direction_all.py**: 计算相对方向（三个难度层次）
- **c_relative_distance_tool/relative_distance_all.py**: 计算相对距离
- **c_route_plan_tool/route_plan_all.py**: 生成路径规划
- **难度**: easy (object_count), hard (relative_direction), medium (relative_distance), hard (route_plan)

### 4. 序列类脚本 (s_*)
- **s_appearance_order_tool/appearance_order_all.py**: 计算出现顺序
- **难度**: medium

## 新的JSON格式

### 简化后的JSON结构
```json
{
  "video_id": "20250820-151238",
  "video_path": "output_video/20250820-151238.mp4",
  "qa_pairs": [
    {
      "video_id": "20250820-151238",
      "video_path": "output_video/20250820-151238.mp4",
      "question": "问题文本",
      "answer": "答案",
      "question_type": "问题类型",
      "difficulty": "难度级别"
    }
  ],
  "statistics": {
    "total_qa_pairs": 5113,
    "by_difficulty": {
      "easy": 1683,
      "medium": 1758,
      "hard": 1672
    },
    "by_category": {
      "m_absolute_distance": 71,
      "c_relative_direction": 5016,
      ...
    }
  }
}
```

### 主要改进
1. **去掉了metadata字段**：简化了数据结构
2. **添加了难度标签**：easy, medium, hard
3. **统一了视频路径**：指向 `output_video/` 目录
4. **添加了统计信息**：按难度和类别统计

## 使用方法

### 1. 单个数据文件夹处理

#### 方法1：使用新的批量处理脚本
```bash
# 处理单个文件夹
python batch_process_csv_to_json.py --data_root data --parallel 1
```

#### 方法2：手动运行各个脚本
```bash
# 1. 数据清理
python 0_data_cleanup_tool/anno_extraction.py --data_subdir 20250820-151238

# 2. 运行各个工具脚本
python m_absolute_distance_tool/absolute_distance_all.py
python m_object_size_tool/object_size_all.py
python m_room_size_tool/room_size_all.py
python c_object_count_tool/object_count_all.py
python c_relative_direction_tool/relative_direction_all.py
python c_relative_distance_tool/relative_distance_all.py
python c_route_plan_tool/route_plan_all.py
python s_appearance_order_tool/appearance_order_all.py

# 3. 生成JSON文件
python create_simplified_vqa_dataset.py
```

### 2. 批量处理多个数据文件夹

```bash
# 并行处理4个文件夹
python batch_process_csv_to_json.py --data_root data --parallel 4

# 串行处理所有文件夹
python batch_process_csv_to_json.py --data_root data --parallel 1
```

### 3. 生成视频文件

```bash
# 单个视频生成
python generate_video.py --mode single --data_folder 20250820-151238

# 批量视频生成
python generate_video.py --mode batch --data_root data --parallel 4
```

## 输出文件说明

### CSV文件
每个数据文件夹会生成8个CSV文件：

1. **ranked_unique_actor_anno.csv**: 基础演员信息
2. **absolute_distances_all.csv**: 绝对距离测量
3. **object_size_all.csv**: 物体尺寸测量
4. **room_size_all.csv**: 房间尺寸测量
5. **object_count_all.csv**: 物体计数
6. **relative_direction_all.csv**: 相对方向（包含三个难度层次）
7. **relative_distance_all.csv**: 相对距离
8. **route_plan_all.csv**: 路径规划
9. **appearance_order_all.csv**: 出现顺序

### JSON文件
- **单个数据文件夹**: `output_json/数据文件夹名.json`
- **总体摘要**: `output_json/summary.json`

### 视频文件
- **位置**: `output_video/数据文件夹名.mp4`

## 难度分类

### Easy (简单)
- **c_object_count**: 物体计数问题

### Medium (中等)
- **m_absolute_distance**: 绝对距离测量
- **m_object_size**: 物体尺寸测量
- **m_room_size**: 房间尺寸测量
- **c_relative_distance**: 相对距离
- **s_appearance_order**: 出现顺序

### Hard (困难)
- **c_relative_direction**: 相对方向（包含三个子难度）
  - Hard: 4个选项（front-left, front-right, back-left, back-right）
  - Medium: 3个选项（left, right, back）
  - Easy: 2个选项（left, right）
- **c_route_plan**: 路径规划

## 性能优化

### 并行处理
- 使用 `--parallel` 参数控制并行数量
- 建议并行数量不超过CPU核心数
- 内存使用：每个并行进程约需要500MB-1GB内存

### 错误处理
- 脚本包含超时机制（5分钟）
- 自动跳过缺失依赖的文件夹
- 详细的错误日志和统计信息

## 注意事项

1. **数据完整性**: 确保每个数据文件夹包含 `Screenshot_summary.csv` 文件
2. **内存使用**: 处理大量数据时注意内存使用情况
3. **磁盘空间**: 确保有足够的磁盘空间存储CSV和JSON文件
4. **依赖关系**: 脚本按依赖顺序运行，确保基础数据先生成

## 故障排除

### 常见问题

1. **脚本找不到输入文件**
   - 检查数据文件夹结构
   - 确保 `Screenshot_summary.csv` 存在

2. **内存不足**
   - 减少并行数量
   - 分批处理数据文件夹

3. **超时错误**
   - 增加超时时间
   - 检查数据文件大小

4. **JSON生成失败**
   - 检查CSV文件是否完整
   - 查看错误日志

### 日志文件
- 所有脚本都会输出详细的处理日志
- 错误信息会显示具体的失败原因
- 成功处理的文件会显示输出路径
